<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Talend Component Kit Developer Reference Guide :: Wrapping a Beam I/O</title>
    <link rel="canonical" href="https://talend.github.io/component-runtime/main/1.0.4/wrapping-a-beam-io.html">
    <meta name="generator" content="Talend Component Kit Generator">
<meta name="date" content="2018-07-25T18:15:07.061Z" scheme="YYYY-MM-DDTHH:mm:ss.sssZ">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.css" integrity="sha256-NuCn4IvuZXdBaFKJOAcsU2Q3ZpwbdFisd5dux4jkQ5w=" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/instantsearch.js/2.8.0/instantsearch.min.css" integrity="sha256-vusmcqkVvKdkwoueSJZLlO9y2P+Lp9fN3WwQUV9Uwfw=" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/instantsearch.js/2.8.0/instantsearch-theme-algolia.min.css" integrity="sha256-ZqsS4QagZnfArbOyheCO4qVjzzsMbg/WMvf5tLtId/Q=" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/idea.min.css" integrity="sha256-rD61BPsgKHzJPyg7vpXaYOw6tMYuY2fz1p9033NYeM8=" crossorigin="anonymous" />
<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.1.0/css/all.css" integrity="sha384-lKuwvrZot6UHsBSfcMvOkWwlCMgc0TaWr+30HWe3a4ltaBwTZhyTEggF5tJv8tbt" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@talend/bootstrap-theme@0.200.1/dist/bootstrap.css">
<link rel="stylesheet" href="../../_/css/talend.css">
<link rel="shortcut icon" href="../../_/images/favicon_0.ico" />
    <script async src="https://www.googletagmanager.com/gtag/js?id=GTM-PSBN"></script>
    <script>dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)};gtag('js',new Date());gtag('config','GTM-PSBN')</script>
  </head>
  <body>
      <header class="global-header">
  <nav class="navbar navbar-default">
      <div class="navbar-header">
        <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
          <span class="sr-only">Toggle navigation</span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="index.html">Component Kit  0.0.9</a>
      </div>
      <div id="navbar" class="navbar-collapse collapse">
        <ul class="nav navbar-nav navbar-right">
          <li class="dropdown">
            <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Versions <span class="caret"></span></a>
            <ul class="dropdown-menu">
              <li class="navbar-item version is-latest">
                <a href="../1.0.4/index.html">1.0.4</a>
              </li>
              <li class="navbar-item version">
                <a href="../1.0.3/index.html">1.0.3</a>
              </li>
              <li class="navbar-item version">
                <a href="../1.0.2/index.html">1.0.2</a>
              </li>
              <li class="navbar-item version">
                <a href="../1.0.1/index.html">1.0.1</a>
              </li>
              <li class="navbar-item version">
                <a href="../1.0.0/index.html">1.0.0</a>
              </li>
              <li class="navbar-item version">
                <a href="../0.0.12/index.html">0.0.12</a>
              </li>
              <li class="navbar-item version">
                <a href="../0.0.11/index.html">0.0.11</a>
              </li>
              <li class="navbar-item version">
                <a href="../0.0.10/index.html">0.0.10</a>
              </li>
              <li class="navbar-item version is-current">
                <a href="index.html">0.0.9</a>
              </li>
              <li class="navbar-item version">
                <a href="../0.0.8/index.html">0.0.8</a>
              </li>
              <li class="navbar-item version">
                <a href="../0.0.7/index.html">0.0.7</a>
              </li>
              <li class="navbar-item version">
                <a href="../0.0.6/index.html">0.0.6</a>
              </li>
              <li class="navbar-item version">
                <a href="../0.0.5/index.html">0.0.5</a>
              </li>
              <li class="navbar-item version">
                <a href="../0.0.4/index.html">0.0.4</a>
              </li>
              <li class="navbar-item version">
                <a href="../0.0.3/index.html">0.0.3</a>
              </li>
              <li class="navbar-item version">
                <a href="../0.0.2/index.html">0.0.2</a>
              </li>
              <li class="navbar-item version">
                <a href="../0.0.1/index.html">0.0.1</a>
              </li>
            </ul>
          </li>
        </ul>
        <ul class="nav navbar-nav navbar-right">
          <li class="dropdown">
            <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Repositories <span class="caret"></span></a>
            <ul class="dropdown-menu">
              <li><a class="navbar-item" href="https://github.com/talend/component-api" target="_blank">API</a></li>
              <li><a class="navbar-item" href="https://github.com/talend/component-runtime" target="_blank">Runtime</a></li>
            </ul>
          </li>
          <li class="dropdown">
            <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Community <span class="caret"></span></a>
            <ul class="dropdown-menu">
              <li><a class="navbar-item" href="contributors.html">Contributors</a></li>
              <li><a class="navbar-item" href="https://community.talend.com/t5/Component-Development/bd-p/ComponentDevelopment" target="_blank">Forum</a></li>
            </ul>
          </li>
        </ul>
        <form role="search" action="search.html" class="navbar-form navbar-right">
          <div class="input-group">
            <span class="input-group-addon"><i class="fa fa-search"></i></span>
            <input class="form-control" type="text" placeholder="Search" name="query" id="searchInput">
          </div>
        </form>
      </div>
    </nav>
</header>
            <main class="main">
              <div class="navigation-container grey-background hidden-xs col-sm-2" data-component="main" data-version="0.0.9">
  <aside class="navigation" role="navigation">
    <div class="panels">
      <div class="navigation-menu is-active" data-panel="menu">
        <nav class="nav-menu">
          <!-- <label>Talend Component Kit Developer Reference Guide</label> -->
          <ul class="nav nav-list tree" >
  <li data-depth="0">
      <label class="tree-toggler nav-header"><i class="fa fa-angle-right"></i><span>Programming Model</span></label>
    <ul class="nav nav-list tree" >
  <li data-depth="1">
    <a class="menu-link" href="component-definition.html">Definition Model</a>
  </li>
  <li data-depth="1">
    <a class="menu-link" href="component-configuration.html">Configuration</a>
  </li>
  <li data-depth="1">
    <a class="menu-link" href="component-registering.html">Registration</a>
  </li>
  <li data-depth="1">
    <a class="menu-link" href="gallery.html">Widget Gallery</a>
  </li>
  <li data-depth="1">
    <a class="menu-link" href="component-internationalization.html">Labels and i18n</a>
  </li>
</ul>
  </li>
  <li data-depth="0">
      <label class="tree-toggler nav-header"><i class="fa fa-angle-right"></i><span>Package</span></label>
    <ul class="nav nav-list tree" >
  <li data-depth="1">
    <a class="menu-link" href="component-loading.html">Loading</a>
  </li>
</ul>
  </li>
  <li data-depth="0">
      <label class="tree-toggler nav-header"><i class="fa fa-angle-right"></i><span>Build</span></label>
    <ul class="nav nav-list tree" >
  <li data-depth="1">
    <a class="menu-link" href="build-tools-maven.html">Maven</a>
  </li>
  <li data-depth="1">
    <a class="menu-link" href="build-tools-gradle.html">Gradle</a>
  </li>
</ul>
  </li>
  <li data-depth="0">
      <label class="tree-toggler nav-header"><i class="fa fa-angle-right"></i><span>Services</span></label>
    <ul class="nav nav-list tree" >
  <li data-depth="1">
    <a class="menu-link" href="services-internationalization.html">Internationalization</a>
  </li>
  <li data-depth="1">
    <a class="menu-link" href="services-actions.html">Actions</a>
  </li>
  <li data-depth="1">
    <a class="menu-link" href="services-built-in.html">Built-in services</a>
  </li>
  <li data-depth="1">
    <a class="menu-link" href="services-interceptors.html">Interceptors</a>
  </li>
  <li data-depth="1">
    <a class="menu-link" href="services-custom-api.html">Extend the API</a>
  </li>
</ul>
  </li>
  <li data-depth="0">
      <label class="tree-toggler nav-header"><i class="fa fa-angle-right"></i><span>Execute</span></label>
    <ul class="nav nav-list tree" >
  <li data-depth="1">
    <a class="menu-link" href="services-pipeline.html">Simple/Test Pipeline API</a>
  </li>
  <li data-depth="1">
    <a class="menu-link" href="https://beam.apache.org/documentation/programming-guide/#creating-a-pipeline">Beam Pipeline API</a>
  </li>
</ul>
  </li>
  <li data-depth="0">
      <label class="tree-toggler nav-header"><i class="fa fa-angle-right"></i><span>Testing</span></label>
    <ul class="nav nav-list tree" >
  <li data-depth="1">
    <a class="menu-link" href="testing-best-practices.html">JUnit Integration</a>
  </li>
  <li data-depth="1">
    <a class="menu-link" href="testing-junit.html">Testing HTTP API</a>
  </li>
  <li data-depth="1">
    <a class="menu-link" href="testing-beam.html">Beam case</a>
  </li>
  <li data-depth="1">
    <a class="menu-link" href="testing-spark.html">Spark and JUnit</a>
  </li>
  <li data-depth="1">
    <a class="menu-link" href="testing-multiple-envs.html">Multiple environments for the same tests</a>
  </li>
  <li data-depth="1">
    <a class="menu-link" href="testing-maven-passwords.html">Secrets/Passwords and Maven</a>
  </li>
  <li data-depth="1">
    <a class="menu-link" href="testing-generating-data.html">Generating data?</a>
  </li>
</ul>
  </li>
  <li data-depth="0">
      <label class="tree-toggler nav-header"><i class="fa fa-angle-right"></i><span>Web</span></label>
    <ul class="nav nav-list tree" >
  <li data-depth="1">
    <a class="menu-link" href="documentation-rest.html">Server</a>
  </li>
</ul>
  </li>
  <li data-depth="0">
      <label class="tree-toggler nav-header"><i class="fa fa-angle-right"></i><span>Tutorials</span></label>
    <ul class="nav nav-list tree" >
  <li data-depth="1">
    <a class="menu-link" href="tutorial-generate-project-using-starter.html">Generate a component</a>
  </li>
  <li data-depth="1">
    <a class="menu-link" href="tutorial-create-an-input-component.html">Create an input component</a>
  </li>
  <li data-depth="1">
    <a class="menu-link" href="tutorial-create-an-output-component.html">Create an output component</a>
  </li>
  <li data-depth="1">
    <a class="menu-link" href="tutorial-test-your-components.html">Test your components</a>
  </li>
  <li data-depth="1">
    <a class="menu-link" href="tutorial-configuration-sensitive-data.html">Configuration and sensitive data</a>
  </li>
  <li data-depth="1">
    <a class="menu-link" href="tutorial-create-components-rest-api.html">Create components for REST API</a>
  </li>
  <li data-depth="1">
    <a class="menu-link" href="tutorial-test-rest-api.html">How to test a REST API</a>
  </li>
  <li data-depth="1">
    <a class="menu-link" href="tutorial-dev-vs-ci-setup.html">Dev vs CI setup</a>
  </li>
  <li data-depth="1">
    <a class="menu-link" href="tutorial-talend-intellij-plugin-usage.html">Talend Intellij plugin</a>
  </li>
</ul>
  </li>
</ul>
        </nav>
      </div>
    </div>
  </aside>
</div>
              <div class="col-xs-12 col-sm-10 maincontent">
                <div class="toolbar" role="navigation">

    <ol class="breadcrumb grey-background">
      <li class="crumb active"><a href="wrapping-a-beam-io.html">Wrapping a Beam I/O</a></li>
    </ol>
</div>
                <article class="doc">
        <div class="row">
          <div class="col-sm-9 row">
              <h1>Wrapping a Beam I/O</h1>
            <div class="article-content">
              <div class="sect1">
<h2 id="wrapping-a-beam-io__start"><a class="anchor" href="#wrapping-a-beam-io__start"></a>Limitations</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This part is limited to particular kinds of <a href="https://beam.apache.org/">Beam</a> <code>PTransform</code>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>the <code>PTransform&lt;PBegin, PCollection&lt;?&gt;&gt;</code> for the inputs</p>
</li>
<li>
<p>the <code>PTransform&lt;PCollection&lt;?&gt;, PDone&gt;</code> for the outputs. The outputs also must use a single (composite or not) <code>DoFn</code> in their <code>apply</code> method.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_wrap_an_input"><a class="anchor" href="#_wrap_an_input"></a>Wrap an input</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Assume you want to wrap an input like this one (based on existing Beam ones):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@AutoValue
public abstract [static] class Read extends PTransform&lt;PBegin, PCollection&lt;String&gt;&gt; {

  // config

  @Override
  public PCollection&lt;String&gt; expand(final PBegin input) {
    return input.apply(
        org.apache.beam.sdk.io.Read.from(new BoundedElasticsearchSource(this, null)));
  }

  // ... other transform methods
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>To wrap the Read in a framework component you create a transform delegating to this one with a <code>@PartitionMapper</code> annotation
at least (you likely want to follow the best practices as well adding <code>@Icon</code> and <code>@Version</code>) and using <code>@Option</code> constructor injections
to configure the component:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@PartitionMapper(family = "myfamily", name = "myname")
public class WrapRead extends PTransform&lt;PBegin, PCollection&lt;String&gt;&gt; {
  private PTransform&lt;PBegin, PCollection&lt;String&gt;&gt; delegate;

  public WrapRead(@Option("dataset") final WrapReadDataSet dataset) {
    delegate = TheIO.read().withConfiguration(this.createConfigurationFrom(dataset));
  }

  @Override
  public PCollection&lt;String&gt; expand(final PBegin input) {
    return delegate.expand(input);
  }

  // ... other methods like the mapping with the native configuration (createConfigurationFrom)
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_wrap_an_output"><a class="anchor" href="#_wrap_an_output"></a>Wrap an output</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Assume you want to wrap an output like this one (based on existing Beam ones):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@AutoValue
public abstract [static] class Write extends PTransform&lt;PCollection&lt;String&gt;, PDone&gt; {


    // configuration withXXX(...)

    @Override
    public PDone expand(final PCollection&lt;String&gt; input) {
      input.apply(ParDo.of(new WriteFn(this)));
      return PDone.in(input.getPipeline());
    }

    // other methods of the transform
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can wrap this output exactly the same way than for the inputs but using <code>@Processor</code> this time:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@PartitionMapper(family = "myfamily", name = "myname")
public class WrapRead extends PTransform&lt;PCollection&lt;String&gt;, PDone&gt; {
  private PTransform&lt;PCollection&lt;String&gt;, PDone&gt; delegate;

  public WrapRead(@Option("dataset") final WrapReadDataSet dataset) {
    delegate = TheIO.write().withConfiguration(this.createConfigurationFrom(dataset));
  }

  @Override
  public PDone expand(final PCollection&lt;String&gt; input) {
    return delegate.expand(input);
  }

  // ... other methods like the mapping with the native configuration (createConfigurationFrom)
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_tip"><a class="anchor" href="#_tip"></a>Tip</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Note that the class <code>org.talend.sdk.component.runtime.beam.transform.DelegatingTransform</code> fully delegates
to another transform the "expansion". Therefore you can extend it and just implement the configuration mapping:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Processor(family = "beam", name = "file")
public class BeamFileOutput extends DelegatingTransform&lt;PCollection&lt;String&gt;, PDone&gt; {

    public BeamFileOutput(@Option("output") final String output) {
        super(TextIO.write()
            .withSuffix("test")
            .to(FileBasedSink.convertToFileResourceIfPossible(output)));
    }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_advanced"><a class="anchor" href="#_advanced"></a>Advanced</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In terms of classloading, when you write an IO all the Beam SDK Java core stack is assumed in Talend Component Kit runtime
as provided so never include it in compile scope - it would be ignored anyway.</p>
</div>
<div class="sect2">
<h3 id="_coder"><a class="anchor" href="#_coder"></a>Coder</h3>
<div class="paragraph">
<p>If you need a JSonCoder you can use <code>org.talend.sdk.component.runtime.beam.factory.service.PluginCoderFactory</code> service
which gives you access the JSON-P and JSON-B coders.</p>
</div>
</div>
<div class="sect2">
<h3 id="_sample"><a class="anchor" href="#_sample"></a>Sample</h3>
<div class="paragraph">
<p>Here is a sample input based on beam Kafka:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Version
@Icon(Icon.IconType.KAFKA)
@Emitter(name = "Input")
@AllArgsConstructor
@Documentation("Kafka Input")
public class KafkaInput extends PTransform&lt;PBegin, PCollection&lt;JsonObject&gt;&gt; { <i class="conum" data-value="1"></i><b>(1)</b>

    private final InputConfiguration configuration;

    private final JsonBuilderFactory builder;

    private final PluginCoderFactory coderFactory;

    private KafkaIO.Read&lt;byte[], byte[]&gt; delegate() {
        final KafkaIO.Read&lt;byte[], byte[]&gt; read = KafkaIO.&lt;byte[], byte[]&gt; read()
                .withBootstrapServers(configuration.getBootstrapServers())
                .withTopics(configuration.getTopics().stream().map(InputConfiguration.Topic::getName).collect(toList()))
                .withKeyDeserializer(ByteArrayDeserializer.class).withValueDeserializer(ByteArrayDeserializer.class);
        if (configuration.getMaxResults() &gt; 0) {
            return read.withMaxNumRecords(configuration.getMaxResults());
        }
        return read;
    }

    @Override <i class="conum" data-value="2"></i><b>(2)</b>
    public PCollection&lt;JsonObject&gt; expand(final PBegin pBegin) {
        final PCollection&lt;KafkaRecord&lt;byte[], byte[]&gt;&gt; kafkaEntries = pBegin.getPipeline().apply(delegate());
        return kafkaEntries.apply(ParDo.of(new RecordToJson(builder))).setCoder(coderFactory.jsonp()); <i class="conum" data-value="3"></i><b>(3)</b>
    }

    @AllArgsConstructor
    private static class RecordToJson extends DoFn&lt;KafkaRecord&lt;byte[], byte[]&gt;, JsonObject&gt; {

        private final JsonBuilderFactory builder;

        @ProcessElement
        public void onElement(final ProcessContext context) {
            context.output(toJson(context.element()));
        }

        // todo: we shouldnt be typed string/string so make it evolving
        private JsonObject toJson(final KafkaRecord&lt;byte[], byte[]&gt; element) {
            return builder.createObjectBuilder().add("key", new String(element.getKV().getKey()))
                    .add("value", new String(element.getKV().getValue())).build();
        }
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>the <code>PTransform</code> generics define it is an input (<code>PBegin</code> marker)</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>the <code>expand</code> method chains the native IO with a custom mapper (<code>RecordToJson</code>)</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>the mapper uses the JSON-P coder automatically created from the contextual component</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Since the Beam wrapper doesn&#8217;t respect the standard Kit programming Model (no <code>@Emitter</code> for instance)
you need to set <code>&lt;talend.validation.component&gt;false&lt;/talend.validation.component&gt;</code> property in your <code>pom.xml</code>
(or equivalent for Gradle) to skip the Kit component programming model validations.</p>
</div>
</div>
</div>
</div>
            </div>
          </div>
          <div class="col-sm-3 container article-side-panel">
            <nav class="article-anchors">
              <h1>On this page</h1>
            </nav>
          </div>
          <a href="#top" class="top">Scroll to top</a>
        </div>
        <script>(window.talend = (window.talend || {})).article = true;</script>
    </article>
              </div>
            </main>
      </main>
      <footer class="footer ">
    <div class="footer-with-copyright footer-with-links">
        <ul class="footer-links" style="">
            <li><a class="gwt-Anchor" href="http://www.talend.com/">Talend</a></li>
            <li><a class="gwt-Anchor" href="http://www.talend.com/contact">Contact</a></li>
            <li><a class="gwt-Anchor" href="http://www.talend.com/legal-terms/us-eula">Talend EULA</a></li>
        </ul>
        <div class="footer-copyright" style="">&copy; 2018 Talend Inc. All rights reserved.</div>
    </div>
</footer>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js" integrity="sha256-/BfiIkHlHoVihZdc6TFuj7MmJ0TWcWsMXkeDFwhi0zw=" crossorigin="anonymous"></script>
<script src="https://cdn.rawgit.com/rmannibucau/00206484a54ac569e091513e6d2a1c01/raw/46cd5d77ba1abe678f83d11490e12a327b62d7ee/anchorific.js"></script>
<script src="../../_/js/talend.js"></script>
  </body>
</html>
